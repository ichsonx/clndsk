# 项目地图 (Project Map)

## 项目概述
clndsk 是一个用于清理不需要文件的命令行工具，能够根据文件名中的关键字批量删除文件，并支持清理空文件夹。

## 项目结构
```
/Users/sonic/pyproj/clndsk/
├── clndsk.py                 # 主程序文件
├── .gitignore               # Git 忽略配置
├── .DS_Store                # macOS 系统文件
└── openspec/                # 规范文档目录
    ├── specs/               # 需求规范
    │   └── REQ-2025-002_init-clndsk/ # 初始功能需求
    │       ├── agents.md
    │       ├── spec.md
    │       └── tasks.md
    ├── changes/             # 变更记录
    │   ├── REQ-2025-002_init-clndsk/  # 初始功能变更
    │   │   ├── agents.md
    │   │   ├── spec.md
    │   │   └── tasks.md
    │   └── REQ-2025-003_feat-删除空文件夹/ # 删除空文件夹功能变更
    │       ├── agents.md
    │       ├── spec.md
    │       └── tasks.md
    ├── testuat/             # 用户验收测试
    └── testuat 2/           # 用户验收测试2
```

## 核心文件功能

### clndsk.py
主程序文件，实现以下功能：
- 根据关键字匹配文件名进行批量删除
- 支持递归和非递归遍历
- 支持清理空文件夹
- **最新改进**：增强对 NTFS 文件系统的支持，包括：
  - NTFS 文件系统检测
  - 文件锁定状态检查
  - 删除失败时的重试机制
  - 使用系统命令作为备选删除方法
  - 更详细的错误报告

## 需求规范关联

### REQ-2025-002_init-clndsk (初始功能)
- **目标**：实现基础文件清理功能
- **状态**：已完成
- **功能**：
  - 命令行界面交互
  - 文件路径选择（当前目录或指定路径）
  - 递归/非递归遍历
  - 关键字匹配删除
  - 彩色提示信息

### REQ-2025-003_feat-删除空文件夹 (扩展功能)
- **目标**：添加清理空文件夹功能
- **状态**：已完成
- **功能**：
  - 识别空文件夹
  - 可选的空文件夹清理
  - 删除进度显示

## 最近更新记录

### 2025-11-26
- **增强 NTFS 文件系统支持**
  - 改进 `is_ntfs_volume` 函数，使用 `df` 命令更准确地检测 NTFS 文件系统
  - 添加 `check_file_locked` 函数，检测文件锁定状态
  - 实现删除失败时的重试机制（最多3次）
  - 优化错误处理，提供更详细的错误信息
  - 增加对文件权限和锁定状态的检查
  - 在 NTFS 系统上使用额外的解锁命令

### 2025-11-24
- **添加删除空文件夹功能**
  - 实现空文件夹查找
  - 添加用户选项以选择是否删除空文件夹
  - 实现删除进度显示

### 2025-11-10
- **基础功能完成**
  - 实现命令行交互界面
  - 实现文件匹配和删除功能
  - 添加彩色提示信息

## 技术栈
- Python 3
- 跨平台支持（Windows、Linux、macOS）

## 项目关系图
```
用户请求
  ↓
clndsk.py (主程序)
  ↓
├── find_matching_files() → 查找匹配文件
├── delete_files() → 删除文件 (增强NTFS支持)
├── find_empty_folders() → 查找空文件夹
├── delete_empty_folders() → 删除空文件夹
├── is_ntfs_volume() → NTFS检测
├── check_file_locked() → 文件锁定检测
└── 各种辅助函数 (打印、验证等)
```